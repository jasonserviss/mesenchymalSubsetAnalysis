---
title: "Mesenchymal analysis by eye"
author: "Jason T. Serviss"
date: "30/06/2017"
output:
  html_document:
    code_folding: hide
    highlight: pygments
    theme: readable
---

<style> 
.col2 { columns: 2 200px; /* number of columns and width in pixels*/ -webkit-columns: 2 200px; /* chrome, safari */ -moz-columns: 2 200px; /* firefox */ } 
</style>


```{r loadLibraries, message=FALSE}
packages <- c(
    "mesenchymalAnalysis", 
    "printr",
    "ggthemes",
    "tidyverse",
    "mclust",
    "viridis"
)
purrr::walk(packages, library, character.only = TRUE)
rm(packages)
```

```{r setup}
tsne <- my.tsne.2d.full.top2000.log
counts <- counts.nodups
counts.norm <- countsNorm(counts)
counts.log <- countsLog(counts)

groups.mesenchymal <- groups.mesenchymal.n
groups.fetal <- groupNames()

mes.tsne <- tsne[groups.fetal == "Mesenchymal", ]
mes.counts <- counts[ , groups.fetal == "Mesenchymal"]
mes.norm <- counts.norm[ , groups.fetal == "Mesenchymal"]
mes.log <- counts.log[ , groups.fetal == "Mesenchymal"]
```

#CAN I REMOVE variation from patients using the RegressOut function from seurat?

###Plot all cell types 

```{r, fig.align='center', fig.height=8, fig.width=10, eval=TRUE, message=FALSE, warning=FALSE}
plotAllCellTypes(data.frame(tsne, class = groups.fetal))
```

###t-SNE projected classification of mesenchymal cells.
Plot the bayesian information criteria (BIC) scores for all models and cluster numbers examined.

```{r, fig.align='center', fig.height=8, fig.width=10, eval=TRUE, message=FALSE, warning=FALSE}
BIC = mclustBIC(mes.tsne, G = 1:20)
```

###Plot the classification and uncertainty.
The uncertainty here is the uncertainty in converting a conditional probablility from EM to a classification in model-based clustering.

```{r, fig.align='center', fig.height=8, fig.width=10, eval=TRUE, message=FALSE, warning=FALSE}
mod1 <- Mclust(mes.tsne, G = 1:20, x = BIC)
#summary(mod1, parameters = TRUE)
mesDF <- tibble(
    sample = rownames(mes.tsne),
    tsne.dim1 = mes.tsne[, 1],
    tsne.dim2 = mes.tsne[, 2],
    uncertainty = mod1$uncertainty, 
    class = case_when(
        mod1$classification == 1  ~  "Mesenchymal_1",
        mod1$classification == 2  ~  "Mesenchymal_2",
        mod1$classification == 3  ~  "Mesenchymal_3",
        mod1$classification == 4  ~  "Mesenchymal_4",
        mod1$classification == 5  ~  "Mesenchymal_5",
        mod1$classification == 6  ~  "Mesenchymal_6",
        mod1$classification == 7  ~  "Mesenchymal_7",
        mod1$classification == 8  ~  "Mesenchymal_8",
        mod1$classification == 9  ~  "Mesenchymal_9",
        mod1$classification == 10 ~  "Mesenchymal_10",
        TRUE ~ as.character(mod1$classification)
    )
)
plotMesWithUncert(mesDF)
```

```{r, fig.align='center', fig.height=8, fig.width=10, eval=TRUE, message=FALSE, warning=FALSE}
plotGestWeek("Mesenchymal")
```

```{r, fig.align='center', fig.height=8, fig.width=10, eval=TRUE, message=FALSE, warning=FALSE}
plotPatients("Mesenchymal")
```

```{r}
plotMesClean(mesDF)
```

```{r}
#make new group
s1 <- filter(mesDF, class == "Mesenchymal_4" & tsne.dim2 > 25 & tsne.dim1 < 71 & tsne.dim1 > 62 & tsne.dim2 < 32)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s1, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#add to group 6
s2 <- filter(mesDF, class %in% c("Mesenchymal_4", "Mesenchymal_5") & tsne.dim2 > 28 & tsne.dim1 < 60  & tsne.dim2 < 32)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s2, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s3 <- filter(mesDF, class == "Mesenchymal_4" & tsne.dim2 > 32 & tsne.dim1 < 75 & tsne.dim1 > 62)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s3, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make new group (for now) potential cycling cells
s4 <- filter(mesDF, class == "Mesenchymal_7" & tsne.dim2 < 2.6)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s4, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make new group
s5 <- filter(mesDF, class == "Mesenchymal_2" & tsne.dim1 > 90 & tsne.dim2 > 10)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s5, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s6 <- filter(mesDF, class %in% c("Mesenchymal_2", "Mesenchymal_4") & tsne.dim1 > 80 & tsne.dim2 > 11 & tsne.dim2 < 16 & tsne.dim1 < 89)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s6, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s7 <- filter(mesDF, class == "Mesenchymal_4" & tsne.dim2 < 10)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s7, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#add to group 5
s8 <- filter(mesDF, class == "Mesenchymal_4" & tsne.dim1 < 65)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s8, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s9 <- filter(mesDF, class == "Mesenchymal_4" & tsne.dim1 > 65 & !sample %in% s8 & !sample %in% s1 & !sample %in% s7 & !sample %in% s3 & tsne.dim2 > 22)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s9, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s10 <- filter(mesDF, class == "Mesenchymal_3" & tsne.dim2 < 22)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s10, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s11 <- filter(mesDF, class == "Mesenchymal_7" & tsne.dim1 < 25 & tsne.dim2 < 10)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s11, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

#make undefined
s12 <- filter(mesDF, class %in% c("Mesenchymal_7", "Mesenchymal_5") & tsne.dim1 > 35 & tsne.dim1 < 45)$sample
mesDF %>%
    mutate(class = if_else(sample %in% s12, "new", class)) %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) + 
    geom_point(aes(colour = class))

mesDF %>%
    mutate(class = case_when(
        sample %in% c(s3, s6, s7, s8, s9, s10, s11, s12) ~ "UndefinedMesenchymal",
        sample %in% s1 ~ "new1",
        sample %in% s2 ~ "Mesenchymal_6",
        sample %in% s4 ~ "new4",
        sample %in% s5 ~ "new5",
        TRUE ~ class
    )) %>%
    filter(class != "UndefinedMesenchymal") %>%
    ggplot(., aes(tsne.dim1, tsne.dim2)) +
    geom_point(aes(colour = class)) +
    scale_colour_manual(values =col64())
```

```{r}
data <- mesDF %>%
    mutate(class = case_when(
        sample %in% c(s3, s6, s7, s8, s9, s10, s11, s12) ~ "UndefinedMesenchymal",
        sample %in% s1 ~ "new1",
        sample %in% s2 ~ "Mesenchymal_6",
        sample %in% s4 ~ "new4",
        sample %in% s5 ~ "new5",
        TRUE ~ class
    )) %>%
    filter(class != "UndefinedMesenchymal")

data <- data %>%
    mutate(class = if_else(class %in% c("Mesenchymal_3", "Mesenchymal_4"), "Mesenchymal_3", class))

#calculate mean expression per class per gene
uClass <- unique(data$class)
rv = apply(counts.norm, 1, var)
select = order(rv, decreasing=TRUE)[1:2000]

gr <- sapply(1:length(uClass), function(x) {
    samples <- filter(data, class == uClass[x])$sample
    rowMeans(counts.norm[select, colnames(counts.norm) %in% samples])
})
colnames(gr) <- uClass

c <- cor(gr, method = "spearman")
colnames(c) <- uClass
rownames(c) <- uClass

#cluster for order
clust <- hclust(as.dist(1 - c))
order <- clust[[4]][clust[[3]]]

#reformat correlations 
cors <- c %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    rename(class1 = rowname) %>%
    as_tibble() %>%
    gather(class2, cor, -class1) %>%
    arrange(match(class1, order)) %>%
    mutate(class1 = factor(class1, levels = unique(class1))) %>%
    arrange(match(class2, order)) %>%
    mutate(class2 = factor(class2, levels = unique(class2)))

ggplot(cors, aes(class1, class2)) +
    geom_tile(aes(fill = cor)) +
    geom_text(aes(label = round(cor, digits = 2)), colour = "white") +
    theme_few() +
    theme(
        axis.text.x = element_text(angle=90),
        axis.title = element_blank()
    ) +
    scale_fill_viridis() +
    guides(fill = guide_colourbar(title = "r-squared"))
```

```{r}
KStest2 <- KSstat(counts.norm[ , colnames(counts.norm) %in% data$sample], data$class, cores=6, alpha=0.05) 
save(KStest2, file="~/Github/mesenchymalAnalysis/inst/KStests/KStest2.rda", compress="bzip2")
```

